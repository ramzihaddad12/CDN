#!/bin/bash

# Citation: https://www.baeldung.com/linux/use-command-line-arguments-in-bash-script
while getopts p:o:n:u:i: args
do
	case $args in
		p) port=$OPTARG;;
		o) origin=$OPTARG;;
		n) name=$OPTARG;;
		u) username=$OPTARG;;
		i) keyfile=$OPTARG;;
		?) exit 1;;
	esac
done

dns_server=proj4-dns.5700.network
REPLICAS=(proj4-repl1.5700.network proj4-repl2.5700.network proj4-repl3.5700.network proj4-repl4.5700.network proj4-repl5.5700.network proj4-repl6.5700.network proj4-repl7.5700.network)

# Deploy DNS server
echo "Starting deployment of DNS Server..."

# Managing dns directory
ssh -i $keyfile $username@$dns_server "rm -rf ~/dns; mkdir ~/dns/"

# Secure copying over the needed files 
scp -i $keyfile dnsserver constants.py replicaselector.py $username@$dns_server:~/dns/
wget https://download.wetransfer.com/usgv/a42dd141672e826014c1fb1e1478af4320221211174827/6448265d81f85d258f5f72fccab5780befa6535d/geoipdata.mmdb?token=eyJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2NzA3ODExNjYsImV4cCI6MTY3MDc4MTc2NiwidW5pcXVlIjoiYTQyZGQxNDE2NzJlODI2MDE0YzFmYjFlMTQ3OGFmNDMyMDIyMTIxMTE3NDgyNyIsImZpbGVuYW1lIjoiZ2VvaXBkYXRhLm1tZGIiLCJ3YXliaWxsX3VybCI6Imh0dHA6Ly9zdG9ybS1pbnRlcm5hbC5zZXJ2aWNlLnVzLWVhc3QtMS53ZXRyYW5zZmVyLm5ldC9hcGkvd2F5YmlsbHM_c2lnbmVkX3dheWJpbGxfaWQ9ZXlKZmNtRnBiSE1pT25zaWJXVnpjMkZuWlNJNklrSkJhSE5MZDJWVlJtWjJkU0lzSW1WNGNDSTZJakl3TWpJdE1USXRNVEZVTVRnNk1ESTZORFl1TURBd1dpSXNJbkIxY2lJNkluZGhlV0pwYkd4ZmFXUWlmWDAtLWQ5YzAyMDdmYmE1ODQzYjUxN2VkMzM5YjEzZDE0ZGM0NTk3MDdlNDI1MDA4YTM1ZTc2ZDZjMzFmZDFkODQyNjYiLCJmaW5nZXJwcmludCI6IjY0NDgyNjVkODFmODVkMjU4ZjVmNzJmY2NhYjU3ODBiZWZhNjUzNWQiLCJjYWxsYmFjayI6IntcImZvcm1kYXRhXCI6e1wiYWN0aW9uXCI6XCJodHRwOi8vZnJvbnRlbmQuc2VydmljZS5ldS13ZXN0LTEud2V0cmFuc2Zlci5uZXQvd2ViaG9va3MvYmFja2VuZFwifSxcImZvcm1cIjp7XCJ0cmFuc2Zlcl9pZFwiOlwiYTQyZGQxNDE2NzJlODI2MDE0YzFmYjFlMTQ3OGFmNDMyMDIyMTIxMTE3NDgyN1wiLFwiZG93bmxvYWRfaWRcIjoxNzMyMTMzNTYwMX19In0.1gxkMdCbEDpLqvRVP-TQASodxra-o-lWtmbrJv5Nktc&cf=y -O geoipdata.mmdb $username@$dns_server:~/dns/

echo "Successfully deployed DNS Server!!"

echo "--------------------------------------------------------"

# Deploy Replica server
echo "Starting deployment of Replica Servers..."

for replica_server in "${REPLICAS[@]}"
do
	#  Managing http directory
	ssh -i $keyfile $username@$replica_server "rm -rf ~/http; mkdir ~/http/"

	# Secure copying over the needed files 
	scp -i $keyfile httpserver cacher constants.py utils.py pageviews.csv $username@$replica_server:~/http/

	echo "Caching ... "
	# Do the caching 
	ssh -i $keyfile $username@$replica_server "cd http; ./cacher -p $port -o $origin"
done 

echo "Successfully deployed Replica Servers!!"
